<head>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>–ó–∞–ø–∏—Å–∏ –î–î–°</h1>

    <form method="get">
        <label>–°—Ç–∞—Ç—É—Å:</label>
        <select name="status" id="status-select">
            <option value="">-- –í—Å–µ --</option>
            {% for stat in statuses %}
                <option value="{{ stat.id }}" {% if stat.id|stringformat:"s" == selected_status %}selected{% endif %}>
                    {{ stat.name }}
                </option>
            {% endfor %}
        </select>

        <label>–¢–∏–ø:</label>
        <select name="type" id="type-select">
            <option value="">-- –í—Å–µ --</option>
            {% for t in types %}
                <option value="{{ t.id }}" {% if t.id|stringformat:"s" == selected_type %}selected{% endif %}>
                    {{ t.name }}
                </option>
            {% endfor %}
        </select>

        <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
        <select name="category" id="category-select">
            <option value="">-- –í—Å–µ --</option>
            {% for cat in categories %}
                <option value="{{ cat.id }}" {% if cat.id|stringformat:"s" == selected_category %}selected{% endif %}>
                    {{ cat.name }}
                </option>
            {% endfor %}
        </select>

        <label>–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
        <select name="subcategory" id="subcategory-select">
            <option value="">-- –í—Å–µ --</option>
            {% for sub in subcategories %}
                <option value="{{ sub.id }}" {% if sub.id|stringformat:"s" == selected_subcategory %}selected{% endif %}>
                    {{ sub.name }}
                </option>
            {% endfor %}
        </select>


        <label>–î–∞—Ç–∞ —Å:</label>
        <input type="date" name="start_date" value="{{ start_date }}">

        <label>–ø–æ:</label>
        <input type="date" name="end_date" value="{{ end_date }}">

        <label>–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –¥–∞—Ç–µ:</label>
        <select name="sort">
            <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>–ü–æ —É–±—ã–≤–∞–Ω–∏—é</option>
            <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
        </select>

        <button type="submit">–§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å</button>
        <a href="{% url 'record_list' %}">–°–±—Ä–æ—Å–∏—Ç—å</a>
    </form>

    <hr>

    <table border="1">
        <tr>
            <th>–î–∞—Ç–∞</th>
            <th>–¢–∏–ø</th>
            <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
            <th>–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è</th>
            <th>–°—É–º–º–∞</th>
            <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
        {% for record in records %}
            <tr>
                <td>{{ record.created_at }}</td>
                <td>{{ record.type }}</td>
                <td>{{ record.category.name }}</td>
                <td>{{ record.subcategory.name }}</td>
                <td>{{ record.amount }}</td>
                <td>{{ record.comment }}</td>
                <td>
                    <a href="{% url 'record_edit' record.pk %}">‚úèÔ∏è</a>
                    <a href="{% url 'record_delete' record.pk %}">üóëÔ∏è</a>
                </td>
            </tr>
        {% empty %}
            <tr><td colspan="7">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</td></tr>
        {% endfor %}
    </table>

    <script>
    $(document).ready(function () {
        // –∑–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ç–∏–ø–∞
        $('#type-select').change(function () {
            let typeId = $(this).val();
            $.ajax({
                url: "{% url 'ajax_load_categories' %}",
                data: { 'type': typeId },
                success: function (data) {
                    let categorySelect = $('#category-select');
                    categorySelect.empty().append('<option value="">-- –í—Å–µ --</option>');
                    data.forEach(item => categorySelect.append(
                        `<option value="${item.id}">${item.name}</option>`
                    ));
                    $('#subcategory-select').empty().append('<option value="">-- –í—Å–µ --</option>');
                }
            });
        });

        // –∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        $('#category-select').change(function () {
            let categoryId = $(this).val();
            $.ajax({
                url: "{% url 'ajax_load_subcategories' %}",
                data: { 'category': categoryId },
                success: function (data) {
                    let subSelect = $('#subcategory-select');
                    subSelect.empty().append('<option value="">-- –í—Å–µ --</option>');
                    data.forEach(item => subSelect.append(
                        `<option value="${item.id}">${item.name}</option>`
                    ));
                }
            });
        });
    });
    </script>

    <script>
    $(document).ready(function () {
        $('select[name="category"]').change(function () {
            var url = "{% url 'ajax_load_subcategories' %}";
            var categoryId = $(this).val();

            $.ajax({
                url: url,
                data: {
                    'category': categoryId
                },
                success: function (data) {
                    const subcat = $('select[name="subcategory"]');
                    subcat.empty();
                    subcat.append('<option value="">-- –í—Å–µ --</option>');
                    $.each(data, function (key, value) {
                        subcat.append('<option value="' + value.id + '">' + value.name + '</option>');
                    });
                }
            });
        });
    });
    </script>

</body>